<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <script src="https://cdn.jsdelivr.net/npm/luxon@3.0.1"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1.2.0"></script>
    <style>
        .chart-container {
            width: 80%;
            margin: 30px auto;
            border: 1px solid #eee;
            padding: 20px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        .chart-title {
            text-align: center;
            margin-bottom: 20px;
            color: #333;
        }

    </style>
</head>
<body>
    <div class="chart-container">
        <h2 class="chart-title">Anaconda Download Count</h2>
        <canvas id="downloadChart"></canvas>
    </div>
    
    <div class="chart-container">
        <h2 class="chart-title">Cite Count</h2>
        <canvas id="citeChart"></canvas>
    </div>

    <div class="chart-container">
        <h2 class="chart-title">Star Count</h2>
        <canvas id="starChart"></canvas>
    </div>
    <script>

    Chart.defaults.elements.line.tension = 0.3;
    Chart.defaults.elements.line.fill = true;
    // Chart.defaults.datasets.spanGaps = true;

    function mycallback(context) {
        let label = context.dataset.label || '';
        if (label) {
            label += ': ';
        }
        if (context.parsed.y !== null) {
            label += context.parsed.y;
        } else {
            label += 'No data';
        }
        return label;
    }
    
    const colors = [
        { border: 'rgb(75, 192, 192)', background: 'rgba(75, 192, 192, 0.1)' },
        { border: 'rgb(255, 99, 132)', background: 'rgba(255, 99, 132, 0.1)' },
        { border: 'rgb(54, 162, 235)', background: 'rgba(54, 162, 235, 0.1)' },
        { border: 'rgb(255, 205, 86)', background: 'rgba(255, 205, 86, 0.1)' },
        { border: 'rgb(153, 102, 255)', background: 'rgba(153, 102, 255, 0.1)' },
        { border: 'rgb(201, 203, 207)', background: 'rgba(201, 203, 207, 0.1)' }
    ];

    function add_chart(canvasId, jsonFilePaths) {          
        const ctx = document.getElementById(canvasId).getContext('2d');
            
        if (typeof jsonFilePaths === 'string') {
            jsonFilePaths = [jsonFilePaths];
        }

    // Create promises for all fetch requests
    const fetchPromises = jsonFilePaths.map((filePath, index) => 
        fetch(filePath)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Failed to load ${filePath}: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                // Extract filename for label (remove path and extension)
                const fileName = filePath.split('/').pop().replace('.json', '');
                // remove 'star' prefix if exists
                const cleanName = fileName.replace(/^star/, '');
                return {
                    dates: data.dates,
                    counts: data.counts,
                    label: cleanName,
                    color: colors[index % colors.length],
                    // Store as date objects for proper sorting and comparison
                    dateObjects: data.dates.map(date => new Date(date))
                };
            })
            .catch(error => {
                console.error(`Error loading ${filePath}:`, error);
                throw error;
            })
    );
    
    // Wait for all promises to resolve
    Promise.all(fetchPromises)
        .then(datasetsData => {
            // Combine all unique dates from all datasets and sort them
            const allDatesSet = new Set();
            datasetsData.forEach(data => {
                data.dates.forEach(date => allDatesSet.add(date));
            });
            
            const allDates = Array.from(allDatesSet).sort((a, b) => new Date(a) - new Date(b));
            
            // Create datasets for Chart.js with aligned data
            const datasets = datasetsData.map((data, index) => {
                // Create a map for quick lookup of counts by date
                const dateCountMap = new Map();
                data.dates.forEach((date, i) => {
                    dateCountMap.set(date, data.counts[i]);
                });
                
                // Create aligned data array (null for missing dates)
                const alignedData = allDates.map(date => {
                    return dateCountMap.has(date) ? dateCountMap.get(date) : null;
                });
                
                return {
                    label: data.label,
                    data: alignedData,
                    borderColor: data.color.border,
                    backgroundColor: data.color.background,
                    // tension: 0.3,
                    // fill: true,
                    spanGaps: true, // Allow connecting lines across gaps
                    // pointBackgroundColor: data.color.border,
                    // pointBorderColor: '#fff',
                    // pointBorderWidth: 2,
                    // pointRadius: 3,
                    // pointHoverRadius: 5
                };
            });

            // debugging logs
            // console.log('All Dates:', allDates);
            // console.log('Datasets:', datasets);
                    
                    // 创建图表
                    new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: allDates,
                            // datasets: [{
                            //     label: 'count',
                            //     data: values,
                            //     borderColor: 'rgb(75, 192, 192)',
                            //     backgroundColor: 'rgba(75, 192, 192, 0.1)',
                            //     tension: 0.3,
                            //     fill: true
                            // }]
                            datasets: datasets
                        },
                        options: {
                            responsive: true,
                            interaction: {
                                intersect: false,
                                mode: 'index'
                            },
                            scales: {
                                x: {
                                    type: 'time',
                                    time: {
                                        parser: 'yyyy-MM-dd',
                                        unit: 'day',
                                        tooltipFormat: 'yyyy-MM-dd',
                                        displayFormats: {
                                            day: 'yyyy-MM'
                                        }
                                    },
                                    ticks: {
                                        maxTicksLimit: 10,
                                    },
                                    title: {
                                        display: true,
                                        text: 'date'
                                    },
                                    grid: {
                                        display: false
                                    }
                                },
                                y: {
                                    title: {
                                        display: true,
                                        text: 'count'
                                    },
                                    min: 0
                                }
                            },
                            plugins: {
                                legend: {
                                    display: datasets.length > 1,
                                    position: 'top'
                                },
                                tooltip: {
                                    mode: 'index',
                                    callbacks: { label: mycallback }
                                }
                            }
                        }
                    });
                }).catch(error => {
                    console.error('Error creating chart:', error);
                    throw error;
            });
    }
    // 调用函数，传入JSON文件的路径
    document.addEventListener('DOMContentLoaded', function() {
    add_chart('downloadChart', './count/download.json');
    add_chart('citeChart', './count/cite.json');
    add_chart('starChart', ['./count/stargithub.json', './count/stargitlab.json']);
    });
    </script>
</body>
</html>